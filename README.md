# ğŸ“š Nginx æ—¥å¿—å…¨èƒ½åˆ†æå™¨ä½¿ç”¨æŒ‡å—

> ä¸€æ¬¾æ— éœ€ä¾èµ–ã€æ”¯æŒå¤šæ–‡ä»¶ã€å¸¦æ—¶é—´çª—å£è¿‡æ»¤çš„ Nginx æ—¥å¿—å®‰å…¨åˆ†æå·¥å…·  
> âœ… æ”¯æŒ `.log` å’Œ `.gz` å‹ç¼©æ—¥å¿—  
> âœ… è‡ªåŠ¨è¯†åˆ«æ—¶é—´èŒƒå›´ï¼ˆæœ€è¿‘1å°æ—¶ã€ä»Šå¤©ç­‰ï¼‰  
> âœ… æ™ºèƒ½åˆ†ç»„å¯ç–‘ IPï¼ˆé«˜é¢‘+é«˜é”™è¯¯ç‡ã€æ•æ„Ÿè·¯å¾„æ‰«æç­‰ï¼‰  
> âœ… å¯æŸ¥è¯¢ç‰¹å®š IP æˆ–æ¥å£è·¯å¾„

---

## ğŸ“¦ ä¸€ã€å¿«é€Ÿå¼€å§‹

### 1. ä¸‹è½½è„šæœ¬
```bash
https://github.com/xgrug/log_analyzer.git
```


### 2. èµ‹äºˆæ‰§è¡Œæƒé™
```bash
chmod +x log_analyzer.py
```


### 3. åŸºç¡€è¿è¡Œï¼ˆå…¨å±€åˆ†æï¼‰
```bash
./log_analyzer.py /var/log/nginx/access.log
```


> é»˜è®¤æ˜¾ç¤º Top 20 IPã€Top 20 è·¯å¾„ã€çŠ¶æ€ç åˆ†ç±»ç»Ÿè®¡ã€‚

---

## â±ï¸ äºŒã€æ—¶é—´çª—å£è¿‡æ»¤ï¼ˆå…³é”®åŠŸèƒ½ï¼ï¼‰

åªåˆ†æ **æœ€è¿‘ä¸€æ®µæ—¶é—´** çš„æ—¥å¿—ï¼Œé¿å…å…¨é‡æ‰«æï¼Œæå‡æ•ˆç‡ä¸å‡†ç¡®æ€§ã€‚

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `--last 1h` | æœ€è¿‘ 1 å°æ—¶ |
| `--last 24h` | æœ€è¿‘ 24 å°æ—¶ |
| `--last 7d` | æœ€è¿‘ 7 å¤© |
| `--today` | ä»…ä»Šå¤©ï¼ˆä» 00:00 å¼€å§‹ï¼‰|

### ç¤ºä¾‹ï¼š
```bash
# åˆ†ææœ€è¿‘1å°æ—¶çš„å¯ç–‘è¡Œä¸º
./log_analyzer.py access.log --last 1h --group-by freq-status

# æŸ¥çœ‹ä»Šå¤©è®¿é—®é‡æœ€é«˜çš„è·¯å¾„
./log_analyzer.py *.log --today --top 10
```


> ğŸ’¡ **æç¤º**ï¼šæ—¶é—´åŸºäºæœåŠ¡å™¨æœ¬åœ°æ—¶åŒºè‡ªåŠ¨åŒ¹é…æ—¥å¿—ä¸­çš„æ—¶åŒºï¼ˆå¦‚ `+0800`ï¼‰ã€‚

---

## ğŸ” ä¸‰ã€å››ç§æ ¸å¿ƒåˆ†ææ¨¡å¼

### æ¨¡å¼ 1ï¼šå…¨å±€æ¦‚è§ˆï¼ˆé»˜è®¤ï¼‰
```bash
./log_analyzer.py access.log --last 24h
```

è¾“å‡ºï¼š
- çŠ¶æ€ç åˆ†ç±»ï¼ˆ2xx/4xx/5xxï¼‰
- IP è¯·æ±‚é‡åˆ†ç»„ï¼ˆè¶…é«˜é¢‘/é«˜é¢‘/ä¸­é¢‘/ä½é¢‘ï¼‰
- Top IP ä¸ Top è·¯å¾„

---

### æ¨¡å¼ 2ï¼šæŒ‰è¡Œä¸ºç‰¹å¾åˆ†ç»„ï¼ˆæ¨èç”¨äºå®‰å…¨æ’æŸ¥ï¼‰
```bash
./log_analyzer.py access.log --last 1h --group-by freq-status
```


è¾“å‡ºåˆ†ç»„ç¤ºä¾‹ï¼š
- ğŸ”´ é«˜é¢‘ + é«˜é”™è¯¯ç‡ â†’ **ç–‘ä¼¼æš´åŠ›ç ´è§£æˆ–æ‰«æå™¨**
- ğŸŸ¡ ä¸­é¢‘ + æ•æ„Ÿè·¯å¾„é›†ä¸­ â†’ **å¯èƒ½åœ¨æ¢æµ‹ç™»å½•/ç®¡ç†æ¥å£**
- ğŸŸ  é«˜é¢‘ + ä½é”™è¯¯ç‡ â†’ **å¯èƒ½æ˜¯åˆæ³•çˆ¬è™«æˆ– CDN**
- âšª ä½é¢‘ + é«˜é”™è¯¯ç‡ â†’ **å•æ¬¡è¯•æ¢æ€§æ”»å‡»**

> âœ… æ”¯æŒè‡ªå®šä¹‰é˜ˆå€¼ï¼ˆè§ä¸‹æ–‡â€œé«˜çº§é…ç½®â€ï¼‰

---

### æ¨¡å¼ 3ï¼šå®šå‘æŸ¥è¯¢

#### æŸ¥è¯¢ç‰¹å®š IP è¡Œä¸º
```bash
./log_analyzer.py access.log --ip 192.168.1.100 --last 1h
```

è¾“å‡ºè¯¥ IPï¼š
- æ€»è¯·æ±‚æ¬¡æ•°
- è®¿é—®çš„è·¯å¾„åˆ—è¡¨
- çŠ¶æ€ç åˆ†å¸ƒ
- ä½¿ç”¨çš„ User-Agent

#### æŸ¥è¯¢ç‰¹å®šæ¥å£è·¯å¾„
```bash
./log_analyzer.py access.log --path "/api/user/login" --today
```

è¾“å‡ºè¯¥è·¯å¾„ï¼š
- æ€»è®¿é—®é‡
- è®¿é—® IP æ’å
- é”™è¯¯ç‡ï¼ˆ4xx/5xxï¼‰
- å¸¸è§ UA

---

### æ¨¡å¼ 4ï¼šå¤šç§è¾“å‡ºæ ¼å¼æ”¯æŒ
```bash
# JSONæ ¼å¼è¾“å‡º
./log_analyzer.py access.log --output-format json

# CSVæ ¼å¼è¾“å‡º
./log_analyzer.py access.log --today --output-format csv
```


---

## ğŸ“ å››ã€å¤šæ—¥å¿—æ–‡ä»¶åˆå¹¶åˆ†æ

æ”¯æŒåŒæ—¶åˆ†æå¤šä¸ªæ—¥å¿—æ–‡ä»¶ï¼ˆåŒ…æ‹¬å‹ç¼©åŒ…ï¼‰ï¼š

```bash
# åˆ†æå½“å‰æ—¥å¿— + æ‰€æœ‰å†å²å‹ç¼©æ—¥å¿—
./log_analyzer.py /var/log/nginx/access.log /var/log/nginx/access.log.*.gz --last 24h

# åˆ†ææ•´ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ—¥å¿—
./log_analyzer.py /logs/nginx/*.log /logs/nginx/*.gz --today
```


> âœ… è‡ªåŠ¨è·³è¿‡ä¸å­˜åœ¨çš„æ–‡ä»¶  
> âœ… è‡ªåŠ¨è§£å‹ `.gz` æ–‡ä»¶ï¼ˆæ— éœ€æ‰‹åŠ¨ `gunzip`ï¼‰

---

## âš™ï¸ äº”ã€é«˜çº§é…ç½®ï¼ˆé˜ˆå€¼è°ƒä¼˜ï¼‰

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--high-freq` | 1000 | é«˜é¢‘è¯·æ±‚é˜ˆå€¼ï¼ˆâ‰¥ æ­¤å€¼è§†ä¸º"é«˜é¢‘"ï¼‰ |
| `--mid-freq` | 100 | ä¸­é¢‘è¯·æ±‚é˜ˆå€¼ |
| `--error-rate` | 0.5 | é”™è¯¯ç‡é˜ˆå€¼ï¼ˆ50% ä»¥ä¸Šç®—"é«˜é”™è¯¯ç‡"ï¼‰ |
| `--sensitive-ratio` | 0.5 | æ•æ„Ÿè·¯å¾„å æ¯”é˜ˆå€¼ |
| `--sensitive-paths` | å†…ç½®åˆ—è¡¨ | è‡ªå®šä¹‰æ•æ„Ÿè·¯å¾„ï¼ˆé€—å·åˆ†éš”ï¼‰ |
| `--top` | 20 | Top N æ˜¾ç¤ºæ•°é‡ |
| `--output-format` | text | è¾“å‡ºæ ¼å¼ï¼ˆtext/json/csvï¼‰ |
| `--filter-status` | æ—  | åªåˆ†æç‰¹å®šçŠ¶æ€ç ç±»åˆ«ï¼ˆ2xx/3xx/4xx/5xxï¼‰ |
| `--anonymize-ip` | false | åŒ¿ååŒ–IPåœ°å€æ˜¾ç¤º |

### ç¤ºä¾‹ï¼šé™ä½é˜ˆå€¼ä»¥å‘ç°æ›´éšè”½çš„æ”»å‡»
```bash
./log_analyzer.py access.log --last 6h \
  --group-by freq-status \
  --high-freq 500 \
  --mid-freq 50 \
  --error-rate 0.3 \
  --sensitive-paths "/login,/admin,/api/v1/debug"
```


### ç¤ºä¾‹ï¼šå¤šç§è¾“å‡ºæ ¼å¼
```bash
# JSONæ ¼å¼è¾“å‡ºåˆ†ç»„ç»“æœ
./log_analyzer.py access.log --last 1h --group-by freq-status --output-format json

# CSVæ ¼å¼è¾“å‡ºç‰¹å®šIPåˆ†æç»“æœ
./log_analyzer.py access.log --ip 192.168.1.100 --output-format csv

# åŒ¿ååŒ–IPåœ°å€æ˜¾ç¤º
./log_analyzer.py access.log --today --anonymize-ip
```


### ç¤ºä¾‹ï¼šçŠ¶æ€ç è¿‡æ»¤
```bash
# åªåˆ†æ4xxé”™è¯¯
./log_analyzer.py access.log --filter-status 4xx --last 1h

# åªåˆ†æ5xxé”™è¯¯
./log_analyzer.py access.log --filter-status 5xx --today
```


> ğŸ’¡ **å»ºè®®**ï¼šåœ¨ä¸šåŠ¡ä½å³°æœŸé€‚å½“é™ä½é˜ˆå€¼ï¼Œæé«˜æ£€æµ‹çµæ•åº¦ã€‚

---

## ğŸ›¡ï¸ å…­ã€å…¸å‹å®‰å…¨åœºæ™¯ç”¨æ³•

### åœºæ™¯ 1ï¼šçªå‘ 5xx é”™è¯¯æ’æŸ¥
```bash
./log_analyzer.py access.log --last 10m --top 30
```

â†’ å¿«é€Ÿå®šä½æ˜¯å¦ç”±æŸä¸ª IP é¢‘ç¹è¯·æ±‚å¼‚å¸¸è·¯å¾„å¯¼è‡´ã€‚

---

### åœºæ™¯ 2ï¼šç–‘ä¼¼æš´åŠ›ç ´è§£æ£€æµ‹
```bash
./log_analyzer.py access.log --last 1h \
  --group-by freq-status \
  --error-rate 0.8
```

â†’ é«˜é”™è¯¯ç‡ + é«˜é¢‘ = æå¯èƒ½åœ¨çˆ†ç ´å¯†ç ã€‚

---

### åœºæ™¯ 3ï¼šæ•æ„Ÿæ¥å£æ³„éœ²ç›‘æ§
```bash
./log_analyzer.py access.log --last 24h \
  --sensitive-paths "/backup.sql,/config.php,.env" \
  --group-by freq-status
```

â†’ è‹¥å‡ºç°å¯¹ `/backup.sql` çš„è®¿é—®ï¼Œç«‹å³å‘Šè­¦ï¼

---

### åœºæ™¯ 4ï¼šè‡ªåŠ¨åŒ–å·¡æ£€ï¼ˆç»“åˆ cronï¼‰
```bash
# æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æœ€è¿‘1å°æ—¶çš„å¼‚å¸¸ IPï¼Œè¾“å‡ºä¸ºJSONæ ¼å¼
0 * * * * /path/to/log_analyzer.py /var/log/nginx/access.log --last 1h --group-by freq-status --output-format json > /tmp/nginx_alert_$(date +\%H).json
```


---

## â“ ä¸ƒã€å¸¸è§é—®é¢˜

### Q1ï¼šæ—¥å¿—æ ¼å¼ä¸åŒ¹é…ï¼Ÿ
> æœ¬å·¥å…·è¦æ±‚æ ‡å‡† **Nginx combined æ ¼å¼**ï¼Œä¾‹å¦‚ï¼š
> ```
> 1.2.3.4 - - [10/Dec/2025:10:30:45 +0800] "GET /login HTTP/1.1" 403 123 "-" "Mozilla/5.0 ..."
> ```

> å¦‚ä½¿ç”¨è‡ªå®šä¹‰æ ¼å¼ï¼Œè¯·å…ˆè½¬æ¢æˆ–ä¿®æ”¹è„šæœ¬æ­£åˆ™ã€‚

### Q2ï¼šä¸­æ–‡ä¹±ç ï¼Ÿ
> è„šæœ¬å·²è®¾ç½® `encoding='utf-8'`ï¼Œè‹¥ä»æœ‰é—®é¢˜ï¼Œå¯å°è¯•åœ¨è„šæœ¬ä¸­å¢åŠ  `errors='replace'`ã€‚

### Q3ï¼šå†…å­˜å ç”¨é«˜ï¼Ÿ
> æ—¶é—´çª—å£è¶Šå°ï¼Œå†…å­˜è¶Šä½ã€‚å»ºè®®å§‹ç»ˆé…åˆ `--last` ä½¿ç”¨ï¼Œé¿å…å…¨é‡åŠ è½½æ•° GB æ—¥å¿—ã€‚

### Q4ï¼šå¦‚ä½•é›†æˆåˆ°SIEMç³»ç»Ÿï¼Ÿ
> ä½¿ç”¨ `--output-format json` å‚æ•°å°†ç»“æœè¾“å‡ºä¸ºJSONæ ¼å¼ï¼Œä¾¿äºSIEMç³»ç»Ÿè§£æå¤„ç†ã€‚

---

## ğŸ‰ æ€»ç»“

| åŠŸèƒ½ | å‘½ä»¤ç¤ºä¾‹ |
|------|--------|
| å¿«é€Ÿå…¨å±€åˆ†æ | `./log_analyzer.py access.log` |
| å®‰å…¨åˆ†ç»„æ’æŸ¥ | `--group-by freq-status --last 1h` |
| è¿½è¸ªæ”»å‡»è€… | `--ip <IP> --last 24h` |
| ç›‘æ§æ•æ„Ÿæ¥å£ | `--path /admin --today` |
| å¤šæ—¥å¿—åˆå¹¶ | `*.log *.gz --last 7d` |
| JSONæ ¼å¼è¾“å‡º | `--output-format json` |
| çŠ¶æ€ç è¿‡æ»¤ | `--filter-status 4xx` |
| IPåŒ¿ååŒ–æ˜¾ç¤º | `--anonymize-ip` |
