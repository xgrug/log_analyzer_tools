# ç”Ÿäº§ç¯å¢ƒé™æµç­–ç•¥åˆ†æå·¥å…·

## ğŸ“– ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [å¤šæ—¶é—´çª—å£é™æµ](#å¤šæ—¶é—´çª—å£é™æµ)
- [å®‰è£…ä¸ä¾èµ–](#å®‰è£…ä¸ä¾èµ–)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [å‘½ä»¤è¡Œå‚æ•°è¯¦è§£](#å‘½ä»¤è¡Œå‚æ•°è¯¦è§£)
- [ä½¿ç”¨åœºæ™¯ä¸æ¡ˆä¾‹](#ä½¿ç”¨åœºæ™¯ä¸æ¡ˆä¾‹)
- [è¾“å‡ºæŠ¥å‘Šè¯´æ˜](#è¾“å‡ºæŠ¥å‘Šè¯´æ˜)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªä¸“ä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡çš„ Nginx è®¿é—®æ—¥å¿—åˆ†æå·¥å…·ï¼Œç”¨äºï¼š

- âœ… **è¯„ä¼°ç°æœ‰é™æµç­–ç•¥**çš„åˆç†æ€§
- ğŸ¯ **ç”Ÿæˆå¤šæ—¶é—´çª—å£é™æµé…ç½®**ï¼ˆ10s/30s/1min/5min/1h/24hï¼‰
- ğŸ” **æ£€æµ‹å¼‚å¸¸æµé‡**ï¼ˆå•ç‚¹çªå‘ã€åˆ†å¸ƒå¼æ”»å‡»ï¼‰
- ğŸ§ª **æ¨¡æ‹Ÿç­–ç•¥æ•ˆæœ**ï¼ˆA/B æµ‹è¯•ï¼‰
- ğŸ“Š **URI çº§åˆ«ç²¾ç»†åŒ–åˆ†æ**

### æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å¤šçª—å£åˆ†æ** | è‡ªåŠ¨åˆ†æ 10s/30s/1min/5min/1h/24h çš„æµé‡ç‰¹å¾ |
| **åˆ†å±‚é˜²æŠ¤** | çŸ­çª—å£é˜²çªå‘ + é•¿çª—å£é˜²æ»¥ç”¨ |
| **å†…å­˜ä¼˜åŒ–** | æµå¼å¤„ç†ï¼Œæ”¯æŒ GB çº§åˆ«æ—¥å¿—æ–‡ä»¶ |
| **é«˜æ€§èƒ½** | 10ä¸‡è¡Œ/ç§’å¤„ç†é€Ÿåº¦ |
| **æ™ºèƒ½è¿‡æ»¤** | è‡ªåŠ¨æ’é™¤çˆ¬è™«ã€å†…éƒ¨ IPã€é”™è¯¯è¯·æ±‚ |

---

## å¤šæ—¶é—´çª—å£é™æµ

### ä¸ºä»€ä¹ˆéœ€è¦å¤šçª—å£ï¼Ÿ

å•ä¸€çª—å£é™æµå­˜åœ¨å±€é™æ€§ï¼š

| é—®é¢˜ | å•ä¸€çª—å£ | å¤šçª—å£æ–¹æ¡ˆ |
|------|----------|-----------|
| ç¬æ—¶çªå‘æ”»å‡» | 10ç§’çª—å£å¯èƒ½å¤ªé•¿ | 1ç§’/5ç§’çª—å£å¿«é€Ÿå“åº” |
| æŒç»­æ»¥ç”¨ | çŸ­çª—å£æ— æ³•è¯†åˆ« | 1å°æ—¶/24å°æ—¶çª—å£æ£€æµ‹ |
| æ­£å¸¸çªå‘ | å¯èƒ½è¯¯æ€ | å¤šå±‚ç»“åˆï¼Œæ›´ç²¾å‡† |

### å·¥å…·æ”¯æŒçš„æ—¶é—´çª—å£

```bash
python rate_limit_analyzer.py access.log
```

**è‡ªåŠ¨åˆ†æçš„çª—å£**ï¼š
- **10ç§’**: é˜²æ­¢ç¬æ—¶ DDoSã€API çªå‘
- **30ç§’**: çŸ­æœŸä¸šåŠ¡é€»è¾‘ä¿æŠ¤
- **1åˆ†é’Ÿ**: å¸¸è§„ API é™æµ
- **5åˆ†é’Ÿ**: ä¸šåŠ¡é€»è¾‘é˜²æŠ¤
- **1å°æ—¶**: é˜²æ­¢è´¦å·æ»¥ç”¨ã€çˆ¬è™«
- **24å°æ—¶**: æ¯æ—¥é…é¢ã€ä»˜è´¹é™åˆ¶

### å¤šçª—å£æ¨èç¤ºä¾‹

```
ã€æ—¶é—´çª—å£å¯¹æ¯”è¡¨ã€‘
çª—å£      P95      P99      å¹³å‡      æœ€å¤§      | æ¨èrate     æ¨èburst   
----------------------------------------------------------------------------------
10ç§’      12       18       8.5       45       | 2r/s         21
30ç§’      35       48       28.3      120      | 2r/s         57
1åˆ†é’Ÿ     68       92       55.7      230      | 2r/s         110
5åˆ†é’Ÿ     320      425      290.5     980      | 2r/s         510
1å°æ—¶     3800     4850     3200.8    8900     | 2r/s         5820
24å°æ—¶    85000    98000    72000.3   150000   | 1r/s         117600
```

### ä¸‰ç§ç»„åˆæ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: å•å±‚é˜²æŠ¤ï¼ˆç®€å•ï¼‰
```nginx
# é€‚åˆï¼šå°å‹åº”ç”¨ã€æµé‡ç®€å•
limit_req zone=limit_10s burst=21 nodelay;
```

#### æ–¹æ¡ˆ B: åŒå±‚é˜²æŠ¤ï¼ˆæ¨èï¼‰
```nginx
# é€‚åˆï¼šå¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒ
# ç¬¬ä¸€å±‚ï¼šé˜²æ­¢ç¬æ—¶çªå‘
limit_req zone=limit_10s burst=21 nodelay;

# ç¬¬äºŒå±‚ï¼šé˜²æ­¢æŒç»­æ»¥ç”¨
limit_req zone=limit_3600s burst=5820;
```

#### æ–¹æ¡ˆ C: ä¸‰å±‚é˜²æŠ¤ï¼ˆé«˜çº§ï¼‰
```nginx
# é€‚åˆï¼šé«˜å®‰å…¨éœ€æ±‚åœºæ™¯
limit_req zone=limit_10s burst=21 nodelay;   # ç¬æ—¶ä¿æŠ¤
limit_req zone=limit_60s burst=110;          # çŸ­æœŸä¿æŠ¤  
limit_req zone=limit_3600s burst=5820;       # é•¿æœŸä¿æŠ¤
```

---

## å®‰è£…ä¸ä¾èµ–

### ç³»ç»Ÿè¦æ±‚

- Python 3.7+
- è‡³å°‘ 512MB å¯ç”¨å†…å­˜ï¼ˆå¤„ç† 100 ä¸‡æ¡æ—¥å¿—ï¼‰

### ä¾èµ–åº“

```bash
# æ ‡å‡†åº“ï¼Œæ— éœ€é¢å¤–å®‰è£…
# å¦‚æœéœ€è¦å¤„ç† .gz å‹ç¼©æ–‡ä»¶ï¼Œç¡®ä¿ç³»ç»Ÿæœ‰ gzip æ”¯æŒ
```

### å®‰è£…

```bash
# ä¸‹è½½è„šæœ¬
wget https://your-repo/rate_limit_analyzer.py

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x rate_limit_analyzer.py

# æµ‹è¯•è¿è¡Œ
python rate_limit_analyzer.py --help
```

---

## å¿«é€Ÿå¼€å§‹

### åœºæ™¯ 1ï¼šé¦–æ¬¡åˆ†æ

```bash
# 1. æµ‹è¯•æ—¥å¿—æ ¼å¼æ˜¯å¦æ­£ç¡®
python rate_limit_analyzer.py access.log --test-parse 10

# 2. åŸºç¡€åˆ†æï¼ˆä½¿ç”¨é»˜è®¤å‚æ•°ï¼‰
python rate_limit_analyzer.py access.log

# 3. æŸ¥çœ‹æ¨èé…ç½®
# è¾“å‡ºä¼šåŒ…å«ä¸‰ç§æ¨¡å¼çš„ Nginx é…ç½®
```

### åœºæ™¯ 2ï¼šè¯„ä¼°ç°æœ‰ç­–ç•¥

```bash
# å‡è®¾ä½ å½“å‰é…ç½®æ˜¯ï¼šrate=20r/s, burst=50
python rate_limit_analyzer.py access.log \
  --window 10 \
  --limit 40 \
  --last 24h
```

**åˆ¤æ–­æ ‡å‡†**ï¼š
- è¿è§„ç‡ < 1%ï¼šç­–ç•¥åˆç† âœ…
- è¿è§„ç‡ 1-5%ï¼šå»ºè®®æ”¾å®½ âš ï¸
- è¿è§„ç‡ > 5%ï¼šç­–ç•¥è¿‡ä¸¥ï¼Œå½±å“æ­£å¸¸ç”¨æˆ· âŒ

### åœºæ™¯ 3ï¼šç”Ÿæˆå®Œæ•´æŠ¥å‘Š

```bash
python rate_limit_analyzer.py access.log \
  --last 24h \
  --detect-anomalies \
  --simulate \
  --output-json report.json \
  --output-config nginx.conf
```

ç”Ÿæˆæ–‡ä»¶ï¼š
- `report.json`ï¼šå®Œæ•´çš„ JSON æ•°æ®æŠ¥å‘Šï¼ˆåŒ…å«æ‰€æœ‰çª—å£çš„ç»Ÿè®¡ï¼‰
- `nginx.conf`ï¼šå¯ç›´æ¥ä½¿ç”¨çš„å¤šçª—å£ Nginx é…ç½®

**nginx.conf ç¤ºä¾‹**ï¼š
```nginx
# æ–¹æ¡ˆ B: åŒå±‚é˜²æŠ¤ï¼ˆæ¨èï¼‰
# çŸ­çª—å£ï¼šé˜²æ­¢ç¬æ—¶çªå‘
limit_req zone=limit_10s burst=21 nodelay;

# é•¿çª—å£ï¼šé˜²æ­¢æŒç»­æ»¥ç”¨
limit_req zone=limit_3600s burst=5820;
```

---

## ä½¿ç”¨åœºæ™¯ä¸æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šæ–°æœåŠ¡ä¸Šçº¿ - å¤šçª—å£é…ç½®

**ç›®æ ‡**ï¼šä¸ºæ–° API æœåŠ¡è®¾ç½®åˆç†çš„å¤šå±‚é™æµ

```bash
# 1. åˆ†ææµ‹è¯•ç¯å¢ƒæµé‡
python rate_limit_analyzer.py test_access.log \
  --output-json test_report.json \
  --output-config test_nginx.conf

# 2. æŸ¥çœ‹å¤šçª—å£æ¨è
cat test_nginx.conf

# 3. é€‰æ‹©åŒå±‚é˜²æŠ¤æ–¹æ¡ˆï¼ˆæ¨èï¼‰
# - 10ç§’çª—å£ï¼šå¿«é€Ÿå“åº”çªå‘
# - 1å°æ—¶çª—å£ï¼šé˜²æ­¢æŒç»­æ»¥ç”¨

# 4. åº”ç”¨é…ç½®å¹¶ç›‘æ§
```

### æ¡ˆä¾‹ 2ï¼šDDoS é˜²æŠ¤å¢å¼º

**ç›®æ ‡**ï¼šå¤šå±‚é˜²æŠ¤æŠµå¾¡ä¸åŒç±»å‹çš„æ”»å‡»

```bash
# åˆ†ææœ€è¿‘çš„æ”»å‡»æµé‡
python rate_limit_analyzer.py attack_logs.log \
  --last 2h \
  --detect-anomalies \
  --output-config ddos_protection.conf

# ç”Ÿæˆçš„é…ç½®åŒ…å«ï¼š
# - 1ç§’çª—å£ï¼šæé€Ÿå“åº”
# - 10ç§’çª—å£ï¼šå¸¸è§„é˜²æŠ¤
# - 1å°æ—¶çª—å£ï¼šæŒç»­æ»¥ç”¨æ£€æµ‹
```

**ç”Ÿæˆçš„å¤šå±‚é…ç½®ç¤ºä¾‹**ï¼š
```nginx
# ä¸‰å±‚é˜²æŠ¤
limit_req zone=limit_10s burst=15 nodelay;    # ç¬¬ä¸€é“é˜²çº¿
limit_req zone=limit_60s burst=80;            # ç¬¬äºŒé“é˜²çº¿
limit_req zone=limit_3600s burst=3000;        # ç¬¬ä¸‰é“é˜²çº¿
```

### æ¡ˆä¾‹ 3ï¼šAPI ç½‘å…³å¤šç§Ÿæˆ·é™æµ

**ç›®æ ‡**ï¼šä¸åŒæ—¶é—´ç»´åº¦çš„é…é¢æ§åˆ¶

```bash
# åˆ†æå„ç§Ÿæˆ·æµé‡
python rate_limit_analyzer.py api_gateway.log \
  --output-json tenant_analysis.json

# æ ¹æ®æŠ¥å‘Šä¸­çš„å¤šçª—å£æ•°æ®é…ç½®ï¼š
# - 1åˆ†é’Ÿé™æµï¼šAPI è°ƒç”¨é¢‘ç‡æ§åˆ¶
# - 1å°æ—¶é™æµï¼šé˜²æ­¢å•ä¸ªç§Ÿæˆ·å ç”¨è¿‡å¤šèµ„æº
# - 24å°æ—¶é™æµï¼šæ¯æ—¥é…é¢é™åˆ¶
```

**é…ç½®ç¤ºä¾‹**ï¼š
```nginx
# å…è´¹ç”¨æˆ·
location /api/free/ {
    limit_req zone=limit_60s burst=100;      # 1åˆ†é’Ÿ100æ¬¡
    limit_req zone=limit_3600s burst=1000;   # 1å°æ—¶1000æ¬¡
    limit_req zone=limit_86400s burst=10000; # æ¯å¤©10000æ¬¡
}

# ä»˜è´¹ç”¨æˆ·
location /api/paid/ {
    limit_req zone=limit_60s burst=500;      # æ›´é«˜é™é¢
    limit_req zone=limit_3600s burst=10000;
    limit_req zone=limit_86400s burst=100000;
}
```

### æ¡ˆä¾‹ 4ï¼šä¿ƒé”€æ´»åŠ¨å‡†å¤‡

**ç›®æ ‡**ï¼šåº”å¯¹çªå‘æµé‡ï¼Œé€‰æ‹©åˆé€‚çš„çª—å£

```bash
# 1. åˆ†æä¸Šæ¬¡ä¿ƒé”€æ•°æ®
python rate_limit_analyzer.py last_promo.log \
  --margin 0.3 \
  --output-json promo_report.json

# 2. æŸ¥çœ‹ä¸åŒçª—å£çš„ P99 å€¼
jq '.recommendations.multi_window' promo_report.json

# 3. é€‰æ‹©ç­–ç•¥ï¼š
# - 10ç§’çª—å£ç”¨ loose æ¨¡å¼ï¼ˆå…è®¸æ›´é«˜çªå‘ï¼‰
# - 1å°æ—¶çª—å£ä¿æŒ balancedï¼ˆé˜²æ­¢æ€»é‡æ»¥ç”¨ï¼‰
```

---

## è¾“å‡ºæŠ¥å‘Šè¯´æ˜

### å¤šçª—å£å¯¹æ¯”è¡¨

```
ã€æ—¶é—´çª—å£å¯¹æ¯”è¡¨ã€‘
çª—å£      P95      P99      å¹³å‡      æœ€å¤§      | æ¨èrate     æ¨èburst   
----------------------------------------------------------------------------------
10ç§’      12       18       8.5       45       | 2r/s         21
30ç§’      35       48       28.3      120      | 2r/s         57
1åˆ†é’Ÿ     68       92       55.7      230      | 2r/s         110
5åˆ†é’Ÿ     320      425      290.5     980      | 2r/s         510
1å°æ—¶     3800     4850     3200.8    8900     | 2r/s         5820
24å°æ—¶    85000    98000    72000.3   150000   | 1r/s         117600
```

**å¦‚ä½•è§£è¯»**ï¼š

1. **P95/P99 å€¼**ï¼š
   - P95=12 è¡¨ç¤º 95% çš„ç”¨æˆ·åœ¨ 10 ç§’å†…è¯·æ±‚ â‰¤ 12 æ¬¡
   - P99=18 è¡¨ç¤º 99% çš„ç”¨æˆ·åœ¨ 10 ç§’å†…è¯·æ±‚ â‰¤ 18 æ¬¡
   - æ¨èçš„ burst åŸºäº P99 + å®‰å…¨è¾¹é™…

2. **çª—å£é€‰æ‹©**ï¼š
   - **çŸ­çª—å£ï¼ˆ10s-1minï¼‰**ï¼š
     - P99 å€¼å°ï¼Œé€‚åˆç²¾ç¡®æ§åˆ¶
     - è¯¯æ€é£é™©ä½
     - æ¨èç”¨äº API æ¥å£ã€è®¤è¯ç«¯ç‚¹
   
   - **é•¿çª—å£ï¼ˆ1h-24hï¼‰**ï¼š
     - P99 å€¼å¤§ï¼Œå®¹è®¸æ›´å¤šç´¯ç§¯
     - é€‚åˆé…é¢ç®¡ç†
     - æ¨èç”¨äºæ¯æ—¥é™é¢ã€ä»˜è´¹ API

3. **rate è®¡ç®—**ï¼š
   ```
   rate = P99 / çª—å£ç§’æ•° * (1 + å®‰å…¨è¾¹é™…)
   
   ä¾‹å¦‚ 1åˆ†é’Ÿçª—å£ï¼š
   rate = 92 / 60 * 1.2 â‰ˆ 2 r/s
   ```

### JSON æŠ¥å‘Šç»“æ„ï¼ˆæ–°å¢å¤šçª—å£ï¼‰

```json
{
  "recommendations": {
    "multi_window": {
      "10s": {
        "window_seconds": 10,
        "window_display": "10ç§’",
        "statistics": {
          "p95": 12,
          "p99": 18,
          "avg": 8.5,
          "max": 45
        },
        "strict": { "rate": 1, "burst": 10 },
        "balanced": { "rate": 2, "burst": 21 },
        "loose": { "rate": 4, "burst": 31 }
      },
      "60s": {
        "window_seconds": 60,
        "statistics": { "p95": 68, "p99": 92 },
        "balanced": { "rate": 2, "burst": 110 }
      },
      "3600s": {
        "window_seconds": 3600,
        "statistics": { "p95": 3800, "p99": 4850 },
        "balanced": { "rate": 2, "burst": 5820 }
      }
    }
  }
}
```

---

## æœ€ä½³å®è·µ

### 1. å¤šçª—å£é…ç½®å†³ç­–æ ‘

```
å¼€å§‹
  â”‚
  â”œâ”€ éœ€è¦é˜²æ­¢ç¬æ—¶ DDoSï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ æ·»åŠ  10ç§’çª—å£ï¼ˆburst=20-50, nodelayï¼‰
  â”‚   â””â”€ å¦ â†’ è·³è¿‡
  â”‚
  â”œâ”€ éœ€è¦ API é¢‘ç‡æ§åˆ¶ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ æ·»åŠ  1åˆ†é’Ÿçª—å£ï¼ˆburst=50-200ï¼‰
  â”‚   â””â”€ å¦ â†’ è·³è¿‡
  â”‚
  â”œâ”€ éœ€è¦é˜²æ­¢è´¦å·æ»¥ç”¨ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ æ·»åŠ  1å°æ—¶çª—å£ï¼ˆburst=1000-10000ï¼‰
  â”‚   â””â”€ å¦ â†’ è·³è¿‡
  â”‚
  â””â”€ éœ€è¦æ¯æ—¥é…é¢é™åˆ¶ï¼Ÿ
      â”œâ”€ æ˜¯ â†’ æ·»åŠ  24å°æ—¶çª—å£ï¼ˆburst=10000-100000ï¼‰
      â””â”€ å¦ â†’ å®Œæˆ
```

### 2. çª—å£ç»„åˆæ¨èè¡¨

| ä¸šåŠ¡åœºæ™¯ | æ¨èç»„åˆ | é…ç½®ç¤ºä¾‹ |
|---------|---------|---------|
| **å…¬å¼€ API** | 10s + 1h | `burst=20 nodelay` + `burst=2000` |
| **ç”¨æˆ·è®¤è¯** | 10s + 5min | `burst=5 nodelay` + `burst=20` |
| **æ–‡ä»¶ä¸Šä¼ ** | 1min + 1h | `burst=10` + `burst=100` |
| **æœç´¢æ¥å£** | 10s + 1min | `burst=10 nodelay` + `burst=50` |
| **ä»˜è´¹ API** | 1min + 24h | `burst=100` + `burst=10000` |
| **åå°ä»»åŠ¡** | 1h + 24h | `burst=1000` + `burst=10000` |

### 3. nodelay ä½¿ç”¨åŸåˆ™

| çª—å£å¤§å° | æ˜¯å¦ä½¿ç”¨ nodelay | åŸå›  |
|---------|-----------------|------|
| â‰¤ 10ç§’ | âœ… æ¨è | å¿«é€Ÿå“åº”ï¼Œç«‹å³æ‹’ç»å¼‚å¸¸ |
| 10-60ç§’ | ğŸŸ¡ å¯é€‰ | æ ¹æ®ä¸šåŠ¡å®¹å¿åº¦å†³å®š |
| â‰¥ 1å°æ—¶ | âŒ ä¸æ¨è | æ’é˜Ÿç­‰å¾…ï¼Œé¿å…è¯¯æ€ |

**é…ç½®ç¤ºä¾‹**ï¼š
```nginx
# çŸ­çª—å£ï¼šç«‹å³æ‹’ç»
limit_req zone=limit_10s burst=20 nodelay;

# é•¿çª—å£ï¼šå…è®¸æ’é˜Ÿï¼ˆä¸åŠ  nodelayï¼‰
limit_req zone=limit_3600s burst=2000;
```

### 4. å®‰å…¨è¾¹é™…å»ºè®®ï¼ˆæŒ‰çª—å£ï¼‰

| çª—å£å¤§å° | æ¨è margin | åŸå›  |
|---------|------------|------|
| 10ç§’-1åˆ†é’Ÿ | 0.1-0.2 | çŸ­çª—å£æµé‡æ³¢åŠ¨å°
```

#### å¿…éœ€å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `logfiles` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒå¤šä¸ªï¼Œæ”¯æŒ .gzï¼‰ | `access.log access.log.1.gz` |

#### åˆ†æå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--window` | 10 | æ—¶é—´çª—å£ï¼ˆç§’ï¼‰ |
| `--limit` | 40 | å½“å‰é™æµé˜ˆå€¼ï¼ˆç”¨äºè¯„ä¼°ï¼‰ |
| `--last` | - | åˆ†ææ—¶é—´èŒƒå›´ï¼š`1h`, `24h`, `7d`, `1w` |
| `--margin` | 0.2 | å®‰å…¨è¾¹é™…ï¼ˆ20%ï¼‰|

#### è¿‡æ»¤å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--exclude-ip` | æ’é™¤ IP/CIDRï¼ˆé€—å·åˆ†éš”ï¼‰ | `"10.0.0.0/8,192.168.1.1"` |
| `--exclude-file` | æ’é™¤ IP åˆ—è¡¨æ–‡ä»¶ | `internal_ips.txt` |
| `--include-status` | åŒ…å«çŠ¶æ€ç  | `"2**,3**"` |
| `--exclude-status` | æ’é™¤çŠ¶æ€ç  | `"404,500"` |
| `--exclude-ua` | é¢å¤–æ’é™¤ UA å…³é”®è¯ | `"test,monitor"` |
| `--no-exclude-ua` | ç¦ç”¨ UA è¿‡æ»¤ | - |

#### é«˜çº§åŠŸèƒ½

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--detect-anomalies` | å¯ç”¨å¼‚å¸¸æ£€æµ‹ |
| `--anomaly-threshold` | å¼‚å¸¸é˜ˆå€¼å€æ•°ï¼ˆé»˜è®¤ 3.0ï¼‰ |
| `--simulate` | æ¨¡æ‹Ÿæ¨èç­–ç•¥æ•ˆæœ |

#### è¾“å‡ºæ§åˆ¶

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--output-json` | JSON æŠ¥å‘Šè¾“å‡ºè·¯å¾„ |
| `--output-config` | Nginx é…ç½®è¾“å‡ºè·¯å¾„ |
| `--quiet` | é™é»˜æ¨¡å¼ï¼ˆä»…è¾“å‡ºæ–‡ä»¶ï¼‰ |
| `--debug` | è°ƒè¯•æ¨¡å¼ |
| `--test-parse` | æµ‹è¯•æ¨¡å¼ï¼ˆåªè§£æå‰ N è¡Œï¼‰ |

#### æ—¥å¿—æ ¼å¼

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--log-format` | Nginx combined | è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ |

**é»˜è®¤æ ¼å¼**ï¼š
```
$remote_addr - - [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent"
```

---

## ä½¿ç”¨åœºæ™¯ä¸æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šæ—¥å¸¸ç›‘æ§

**ç›®æ ‡**ï¼šæ¯æ—¥æ£€æŸ¥é™æµç­–ç•¥æ˜¯å¦éœ€è¦è°ƒæ•´

```bash
#!/bin/bash
# daily_check.sh

LOG_DIR="/var/log/nginx"
REPORT_DIR="/opt/reports"
DATE=$(date +%Y%m%d)

python rate_limit_analyzer.py \
  ${LOG_DIR}/access.log \
  --last 24h \
  --detect-anomalies \
  --output-json ${REPORT_DIR}/report_${DATE}.json

# å¦‚æœæ£€æµ‹åˆ°å¼‚å¸¸ï¼Œå‘é€å‘Šè­¦
if grep -q '"severity": "critical"' ${REPORT_DIR}/report_${DATE}.json; then
    echo "æ£€æµ‹åˆ°ä¸¥é‡å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ï¼" | mail -s "é™æµå‘Šè­¦" admin@example.com
fi
```

### æ¡ˆä¾‹ 2ï¼šä¿ƒé”€æ´»åŠ¨å‡†å¤‡

**ç›®æ ‡**ï¼šé¢„æµ‹ä¿ƒé”€æœŸé—´æµé‡ï¼Œè°ƒæ•´é™æµç­–ç•¥

```bash
# 1. åˆ†æä¸Šæ¬¡ä¿ƒé”€çš„æµé‡
python rate_limit_analyzer.py last_promo_access.log \
  --margin 0.3 \
  --output-config promo_nginx.conf

# 2. æ¨¡æ‹Ÿæ–°ç­–ç•¥
python rate_limit_analyzer.py last_promo_access.log \
  --simulate \
  --output-json promo_simulation.json

# 3. æ ¹æ®æ¨¡æ‹Ÿç»“æœå†³å®šæ˜¯å¦é‡‡ç”¨ loose æ¨¡å¼
```

### æ¡ˆä¾‹ 3ï¼šå®‰å…¨äº‹ä»¶å“åº”

**ç›®æ ‡**ï¼šå¿«é€Ÿè¯†åˆ«æ”»å‡»æµé‡å¹¶ç”Ÿæˆä¸´æ—¶é™æµè§„åˆ™

```bash
# æ£€æµ‹å¼‚å¸¸ï¼ˆæ›´ä¸¥æ ¼çš„é˜ˆå€¼ï¼‰
python rate_limit_analyzer.py access.log \
  --last 1h \
  --detect-anomalies \
  --anomaly-threshold 2.0 \
  --output-json attack_report.json

# æå–å¼‚å¸¸ IP å¹¶ä¸´æ—¶å°ç¦
jq -r '.anomalies[] | select(.severity=="critical") | .ip' attack_report.json > block_ips.txt

# ç”Ÿæˆç´§æ€¥é™æµé…ç½®ï¼ˆstrict æ¨¡å¼ï¼‰
python rate_limit_analyzer.py access.log \
  --last 1h \
  --margin 0 \
  --output-config emergency_nginx.conf
```

### æ¡ˆä¾‹ 4ï¼šæ–°æœåŠ¡ä¸Šçº¿

**ç›®æ ‡**ï¼šä¸ºæ–° API æœåŠ¡è®¾ç½®åˆç†çš„åˆå§‹é™æµ

```bash
# 1. åˆ†ææµ‹è¯•ç¯å¢ƒçš„æµé‡
python rate_limit_analyzer.py test_access.log

# 2. ä½¿ç”¨ balanced æ¨¡å¼é…ç½®
# 3. ä¸Šçº¿åæŒç»­ç›‘æ§ï¼Œé€æ­¥è°ƒæ•´
```

### æ¡ˆä¾‹ 5ï¼šå¤šç¯å¢ƒå¯¹æ¯”

**ç›®æ ‡**ï¼šå¯¹æ¯”ç”Ÿäº§å’Œé¢„å‘ç¯å¢ƒçš„æµé‡å·®å¼‚

```bash
# ç”Ÿäº§ç¯å¢ƒ
python rate_limit_analyzer.py prod_access.log \
  --output-json prod_report.json

# é¢„å‘ç¯å¢ƒ
python rate_limit_analyzer.py staging_access.log \
  --output-json staging_report.json

# å¯¹æ¯” P99 çªå‘
jq '.recommendations.balanced.burst' prod_report.json
jq '.recommendations.balanced.burst' staging_report.json
```

---

## è¾“å‡ºæŠ¥å‘Šè¯´æ˜

### æ§åˆ¶å°è¾“å‡º

#### 1. æ•°æ®æ¦‚è§ˆ

```
ğŸ“Š é™æµç­–ç•¥åˆ†ææŠ¥å‘Š
======================================================================
ã€æ•°æ®æ¦‚è§ˆã€‘
  æ€»è¯·æ±‚æ•°: 1,234,567
  ç‹¬ç«‹ IP æ•°: 45,678
  åˆ†æçª—å£: 10ç§’
  å½“å‰é™åˆ¶: 40 æ¬¡/çª—å£
```

#### 2. ç­–ç•¥è¯„ä¼°

```
ã€å½“å‰ç­–ç•¥è¯„ä¼°ã€‘
  è¿è§„æ¬¡æ•°: 1,234
  è¿è§„ IP æ•°: 156
  è¿è§„æ¯”ä¾‹: 2.34%
  å…¨å±€æœ€å¤§çªå‘: 125
  
ã€çªå‘åˆ†å¸ƒã€‘
  P50: 12  P90: 28  P95: 35  P99: 48
```

**è§£è¯»**ï¼š
- P50ï¼š50% çš„è¯·æ±‚åœ¨ 10 ç§’å†…ä¸è¶…è¿‡ 12 æ¬¡
- P99ï¼š99% çš„è¯·æ±‚åœ¨ 10 ç§’å†…ä¸è¶…è¿‡ 48 æ¬¡
- å¦‚æœ `å½“å‰é™åˆ¶ < P99`ï¼Œä¼šæœ‰è¾ƒé«˜çš„è¯¯æ€ç‡

#### 3. æ¨èé…ç½®

```
ğŸ¯ Nginx é™æµé…ç½®æ¨è
======================================================================
ã€BALANCED æ¨¡å¼ã€‘å‡è¡¡æ¨¡å¼ï¼šæ¨èçš„ç”Ÿäº§é…ç½®
  rate=15r/s  burst=45

  # http å—é…ç½®
  limit_req_zone $binary_remote_addr zone=balanced_limit:10m rate=15r/s;

  # server/location å—é…ç½®
  limit_req zone=balanced_limit burst=45 nodelay;
```

#### 4. URI åˆ†æ

```
ğŸŒ URI è®¿é—®æ¨¡å¼åˆ†æ
======================================================================
  æ€» URI æ•°é‡: 1,245

  URI                                          è¯·æ±‚é‡       10sçªå‘    ç±»å‹       æ¨èburst
  -----------------------------------------------------------------------------------------
  /api/users                                   125,678      38         api        45
  /login                                       45,123       8          auth       9
  /api/orders                                  38,456       42         api        50
```

#### 5. å¼‚å¸¸å‘Šè­¦

```
âš ï¸ å¼‚å¸¸æµé‡å‘Šè­¦
======================================================================
ğŸ”´ CRITICAL çº§åˆ«å‘Šè­¦:
  - IP 192.168.1.100 è¯·æ±‚é‡ 15000 è¿œè¶…åŸºçº¿ 500
    IP: 192.168.1.100
    æŒ‡æ ‡å€¼: 15000 (é˜ˆå€¼: 1500)

ğŸŸ¡ MEDIUM çº§åˆ«å‘Šè­¦:
  - æ£€æµ‹åˆ° 3456 ä¸ªä½é¢‘ IPï¼ˆå¯èƒ½æ˜¯åˆ†å¸ƒå¼æ”»å‡»ï¼‰
    æŒ‡æ ‡å€¼: 3456 (é˜ˆå€¼: 2500)
```

#### 6. ç­–ç•¥æ¨¡æ‹Ÿ

```
ğŸ§ª ç­–ç•¥æ•ˆæœæ¨¡æ‹Ÿï¼ˆä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰
======================================================================
  é…ç½®: rate=15r/s, burst=45
  æ€»è¯·æ±‚: 1,234,567
  è¢«æ‹¦æˆª: 12,345 (1.00%)
  æ”¾è¡Œç‡: 99.00%
  å—å½±å“ IP: 234

  âš–ï¸ ç­–ç•¥å‡è¡¡ï¼Œè¯¯æ€ç‡å¯æ¥å—
```

### JSON æŠ¥å‘Šç»“æ„

```json
{
  "generated_at": "2025-12-12T10:30:00",
  "evaluation": {
    "window_seconds": 10,
    "current_limit": 40,
    "total_requests": 1234567,
    "total_unique_ips": 45678,
    "violations_count": 1234,
    "violation_ratio": 0.0234,
    "burst_analysis": {
      "p50": 12,
      "p90": 28,
      "p95": 35,
      "p99": 48
    }
  },
  "recommendations": {
    "strict": {
      "rate": 8,
      "burst": 22,
      "description": "ä¸¥æ ¼æ¨¡å¼ï¼šé€‚ç”¨äºé«˜å®‰å…¨éœ€æ±‚åœºæ™¯"
    },
    "balanced": {
      "rate": 15,
      "burst": 45,
      "description": "å‡è¡¡æ¨¡å¼ï¼šæ¨èçš„ç”Ÿäº§é…ç½®"
    },
    "loose": {
      "rate": 30,
      "burst": 90,
      "description": "å®½æ¾æ¨¡å¼ï¼šé€‚ç”¨äºçªå‘é«˜å³°åœºæ™¯"
    }
  },
  "uri_analysis": {
    "total_unique_uris": 1245,
    "top_uris": [
      {
        "uri": "/api/users",
        "request_count": 125678,
        "max_burst_10s": 38,
        "uri_type": "api",
        "recommended_burst": 45
      }
    ]
  },
  "anomalies": [
    {
      "type": "spike",
      "severity": "critical",
      "ip": "192.168.1.100",
      "description": "IP 192.168.1.100 è¯·æ±‚é‡ 15000 è¿œè¶…åŸºçº¿ 500",
      "metric_value": 15000,
      "threshold": 1500
    }
  ],
  "simulation": {
    "rate": 15,
    "burst": 45,
    "total_requests": 1234567,
    "blocked_requests": 12345,
    "blocked_ratio": 0.01,
    "affected_ips": 234,
    "pass_through_ratio": 0.99
  }
}
```

---

## æœ€ä½³å®è·µ

### 1. é™æµé…ç½®è°ƒä¼˜æµç¨‹

```
æ­¥éª¤ 1: æ”¶é›†æ•°æ®
  â””â”€> è‡³å°‘æ”¶é›† 24 å°æ—¶çš„å®Œæ•´æ—¥å¿—
  
æ­¥éª¤ 2: åŸºå‡†åˆ†æ
  â””â”€> python rate_limit_analyzer.py access.log --last 24h
  
æ­¥éª¤ 3: è¯†åˆ«å¼‚å¸¸
  â””â”€> python rate_limit_analyzer.py access.log --detect-anomalies
  
æ­¥éª¤ 4: ç­–ç•¥é€‰æ‹©
  â”œâ”€> æ—¥å¸¸ï¼šbalanced æ¨¡å¼
  â”œâ”€> ä¿ƒé”€ï¼šloose æ¨¡å¼
  â””â”€> æ”»å‡»ï¼šstrict æ¨¡å¼
  
æ­¥éª¤ 5: æ¨¡æ‹ŸéªŒè¯
  â””â”€> python rate_limit_analyzer.py access.log --simulate
  
æ­¥éª¤ 6: ç°åº¦ä¸Šçº¿
  â”œâ”€> å…ˆåœ¨ 10% æµé‡ä¸Šæµ‹è¯•
  â”œâ”€> ç›‘æ§è¯¯æ€ç‡
  â””â”€> é€æ­¥æ‰©å¤§èŒƒå›´
  
æ­¥éª¤ 7: æŒç»­ç›‘æ§
  â””â”€> æ¯æ—¥è¿è¡Œåˆ†æï¼Œè°ƒæ•´å‚æ•°
```

### 2. å®‰å…¨è¾¹é™…è®¾ç½®å»ºè®®

| ä¸šåŠ¡ç±»å‹ | æ¨è margin | åŸå›  |
|----------|-------------|------|
| ç”µå•†ï¼ˆä¿ƒé”€æœŸï¼‰ | 0.3-0.5 | æµé‡æ³¢åŠ¨å¤§ |
| SaaS æœåŠ¡ | 0.2 | æµé‡ç›¸å¯¹ç¨³å®š |
| API æœåŠ¡ | 0.15 | æœºå™¨è°ƒç”¨ï¼Œæµé‡å¯é¢„æµ‹ |
| å†…å®¹ç½‘ç«™ | 0.25 | çˆ¬è™«è¾ƒå¤š |
| é‡‘èæ”¯ä»˜ | 0.1 | å®‰å…¨ä¼˜å…ˆ |

### 3. å¤šå±‚é™æµç­–ç•¥

```nginx
# 1. å…¨å±€é™æµï¼ˆæœ€å®½æ¾ï¼‰
limit_req_zone $binary_remote_addr zone=global:10m rate=30r/s;
limit_req zone=global burst=100 nodelay;

# 2. API é™æµï¼ˆä¸­ç­‰ï¼‰
location /api/ {
    limit_req_zone $binary_remote_addr zone=api:10m rate=15r/s;
    limit_req zone=api burst=45 nodelay;
}

# 3. è®¤è¯é™æµï¼ˆæœ€ä¸¥æ ¼ï¼‰
location /login {
    limit_req_zone $binary_remote_addr zone=auth:5m rate=5r/s;
    limit_req zone=auth burst=10 nodelay;
}
```

### 4. ç›‘æ§å‘Šè­¦é˜ˆå€¼

| æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | å¤„ç†å»ºè®® |
|------|----------|----------|
| è¿è§„ç‡ > 5% | âš ï¸ è­¦å‘Š | è€ƒè™‘æ”¾å®½é™åˆ¶ |
| è¿è§„ç‡ > 10% | ğŸ”´ ä¸¥é‡ | ç«‹å³è°ƒæ•´é…ç½® |
| å¼‚å¸¸ IP æ•° > 50 | âš ï¸ è­¦å‘Š | æ£€æŸ¥æ˜¯å¦æœ‰æ”»å‡» |
| P99 çªå‘å¢é•¿ > 50% | âš ï¸ è­¦å‘Š | æµé‡æ¨¡å¼å˜åŒ–ï¼Œéœ€é‡æ–°è¯„ä¼° |

### 5. æ—¥å¿—ä¿ç•™ç­–ç•¥

```bash
# å»ºè®®ä¿ç•™æ—¶é•¿
- åŸå§‹æ—¥å¿—ï¼š7 å¤©ï¼ˆç”¨äºå®æ—¶åˆ†æï¼‰
- å‹ç¼©æ—¥å¿—ï¼š30 å¤©ï¼ˆç”¨äºå›æº¯ï¼‰
- åˆ†ææŠ¥å‘Šï¼š90 å¤©ï¼ˆJSON æ ¼å¼ï¼Œç”¨äºè¶‹åŠ¿åˆ†æï¼‰

# è‡ªåŠ¨åŒ–è„šæœ¬
0 1 * * * /opt/scripts/daily_analysis.sh
0 2 * * 0 /opt/scripts/weekly_report.sh
```

---

## æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šè§£æå¤±è´¥ï¼ˆ0 æ¡æœ‰æ•ˆè¯·æ±‚ï¼‰

**ç—‡çŠ¶**ï¼š
```
[INFO] å¤„ç†å®Œæˆ: 49,747 è¡Œ â†’ 0 æ¡æœ‰æ•ˆè¯·æ±‚
[ERROR] æœªæ‰¾åˆ°æœ‰æ•ˆè®°å½•
```

**è§£å†³æ­¥éª¤**ï¼š

1. **æµ‹è¯•æ—¥å¿—æ ¼å¼**
```bash
python rate_limit_analyzer.py access.log --test-parse 10
```

2. **æ£€æŸ¥æ—¥å¿—æ ·ä¾‹**
```bash
head -5 access.log
```

3. **å¸¸è§æ ¼å¼é—®é¢˜**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| å¼•å·ä¸åŒ¹é… | æ—¥å¿—ä¸­æœ‰ç‰¹æ®Šå­—ç¬¦ | ä½¿ç”¨ `--log-format` è‡ªå®šä¹‰ |
| æ—¶é—´æ ¼å¼å¼‚å¸¸ | éæ ‡å‡†æ—¶åŒºæ ¼å¼ | æ£€æŸ¥æ—¶é—´å­—æ®µ |
| å­—æ®µé¡ºåºé”™è¯¯ | æ—¥å¿—æ ¼å¼è¢«ä¿®æ”¹ | æ ¹æ®å®é™…æ ¼å¼è°ƒæ•´ |

4. **è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼**

å¦‚æœä½ çš„ Nginx ä½¿ç”¨è‡ªå®šä¹‰æ ¼å¼ï¼š

```nginx
# ä½ çš„ nginx.conf
log_format custom '$remote_addr - [$time_local] "$request" $status';
```

ä½¿ç”¨ï¼š
```bash
python rate_limit_analyzer.py access.log \
  --log-format '$remote_addr - [$time_local] "$request" $status'
```

### é—®é¢˜ 2ï¼šå†…å­˜å ç”¨è¿‡é«˜

**ç—‡çŠ¶**ï¼šè¿›ç¨‹å†…å­˜æŒç»­å¢é•¿

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **é™åˆ¶åˆ†ææ—¶é—´èŒƒå›´**
```bash
python rate_limit_analyzer.py access.log --last 6h  # è€Œä¸æ˜¯å…¨é‡
```

2. **åˆ†æ‰¹å¤„ç†**
```bash
# å¤„ç†æœ€è¿‘çš„æ—¥å¿—
python rate_limit_analyzer.py access.log

# å¤„ç†å†å²æ—¥å¿—
python rate_limit_analyzer.py access.log.1.gz access.log.2.gz
```

3. **è°ƒæ•´è®°å½•ä¸Šé™**ï¼ˆä¿®æ”¹è„šæœ¬ï¼‰
```python
MAX_MEMORY_RECORDS = 1_000_000  # ä» 5_000_000 é™ä½
```

### é—®é¢˜ 3ï¼šåˆ†æé€Ÿåº¦æ…¢

**åŸå› ä¸ä¼˜åŒ–**ï¼š

| åŸå›  | ä¼˜åŒ–æ–¹æ¡ˆ |
|------|----------|
| æ—¥å¿—æ–‡ä»¶å¤ªå¤§ | ä½¿ç”¨ `--last` é™åˆ¶æ—¶é—´èŒƒå›´ |
| å‹ç¼©æ–‡ä»¶ | è§£å‹åå†åˆ†æï¼ˆå¦‚æœç£ç›˜ç©ºé—´å……è¶³ï¼‰ |
| URI æ•°é‡è¿‡å¤š | è„šæœ¬ä¼šè‡ªåŠ¨é™åˆ¶åˆ° 100,000 |
| å¼‚å¸¸æ£€æµ‹å¼€é”€ | ä»…åœ¨éœ€è¦æ—¶ä½¿ç”¨ `--detect-anomalies` |

### é—®é¢˜ 4ï¼šæ¨èçš„é™æµè¿‡ä¸¥/è¿‡æ¾

**è°ƒæ•´æ–¹æ³•**ï¼š

```bash
# è¿‡ä¸¥ï¼ˆè¯¯æ€ç‡é«˜ï¼‰â†’ å¢å¤§å®‰å…¨è¾¹é™…
python rate_limit_analyzer.py access.log --margin 0.3

# è¿‡æ¾ï¼ˆä¿æŠ¤ä¸è¶³ï¼‰â†’ å‡å°å®‰å…¨è¾¹é™…
python rate_limit_analyzer.py access.log --margin 0.1

# æˆ–è€…ç›´æ¥ä½¿ç”¨ä¸åŒæ¨¡å¼
# strict â†’ balanced â†’ loose
```

### é—®é¢˜ 5ï¼šçŠ¶æ€ç è¿‡æ»¤ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥ç‚¹**ï¼š

1. **ç¡®è®¤åŒ…å«æ¨¡å¼**
```bash
--include-status "2**,3**"  # æ­£ç¡®ï¼šåªç»Ÿè®¡æˆåŠŸè¯·æ±‚
```

2. **æ’é™¤ç‰¹å®šçŠ¶æ€ç **
```bash
--exclude-status "301,302"  # æ’é™¤é‡å®šå‘
```

3. **æŸ¥çœ‹è¿‡æ»¤ç»Ÿè®¡**
```
[INFO] è¿‡æ»¤ç»Ÿè®¡:
[INFO]   - çŠ¶æ€ç è¿‡æ»¤: 12,345
```

---

## é«˜çº§åŠŸèƒ½

### 1. è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼æ”¯æŒ

æ”¯æŒçš„ Nginx å˜é‡ï¼š

```
$remote_addr        å®¢æˆ·ç«¯ IP
$time_local         è®¿é—®æ—¶é—´
$request            è¯·æ±‚è¡Œï¼ˆåŒ…å« methodã€pathã€protocolï¼‰
$status             çŠ¶æ€ç 
$body_bytes_sent    å“åº”ä½“å¤§å°
$http_referer       æ¥æº
$http_user_agent    User-Agent
$request_time       è¯·æ±‚è€—æ—¶
```

### 2. è¿‡æ»¤å™¨ç»„åˆ

```bash
# å¤æ‚è¿‡æ»¤ç¤ºä¾‹
python rate_limit_analyzer.py access.log \
  --exclude-ip "10.0.0.0/8,172.16.0.0/12" \
  --exclude-file /etc/whitelist_ips.txt \
  --include-status "2**,3**" \
  --exclude-status "301" \
  --exclude-ua "health,monitor,internal"
```

### 3. æ‰¹é‡åˆ†æ

```bash
#!/bin/bash
# åˆ†æä¸€å‘¨çš„æ—¥å¿—

for day in {1..7}; do
    date=$(date -d "-${day} days" +%Y%m%d)
    python rate_limit_analyzer.py \
        /var/log/nginx/access.log.${date}.gz \
        --output-json /opt/reports/report_${date}.json
done

# åˆå¹¶è¶‹åŠ¿åˆ†æ
jq -s 'map(.recommendations.balanced.burst)' /opt/reports/report_*.json
```

### 4. é›†æˆåˆ° CI/CD

```yaml
# .gitlab-ci.yml
rate_limit_check:
  stage: test
  script:
    - python rate_limit_analyzer.py staging_access.log --simulate
    - python check_simulation.py  # è‡ªå®šä¹‰æ£€æŸ¥è„šæœ¬
  only:
    - master
```

### 5. Prometheus é›†æˆ

```python
# å¯¼å‡ºæŒ‡æ ‡åˆ° Prometheus
import json

with open('report.json') as f:
    data = json.load(f)

print(f'rate_limit_p99_burst {data["evaluation"]["burst_analysis"]["p99"]}')
print(f'rate_limit_violation_ratio {data["evaluation"]["violation_ratio"]}')
```

---

## é™„å½•

### A. å®Œæ•´å‚æ•°é€ŸæŸ¥è¡¨

```bash
# åŸºç¡€åˆ†æ
python rate_limit_analyzer.py access.log

# è¯„ä¼°ç°æœ‰ç­–ç•¥
python rate_limit_analyzer.py access.log --window 10 --limit 40

# æ—¶é—´èŒƒ